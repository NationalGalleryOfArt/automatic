<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAPI Preview - LiveAPI Designer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #swagger-ui {
            background: #fafafa;
        }
        .no-spec {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f5f5f5;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        .no-spec-content {
            max-width: 500px;
        }
        .no-spec h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .no-spec p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .no-spec code {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        .no-spec ol {
            text-align: left;
            max-width: 400px;
            margin: 20px auto;
        }
        .no-spec li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="swagger-ui"></div>
    <div id="no-spec" class="no-spec" style="display: none;">
        <div class="no-spec-content">
            <h2>No OpenAPI Specification Found</h2>
            <p>To view your API documentation here:</p>
            <ol>
                <li>Edit the JSON in the designer</li>
                <li>Click "Preview API Spec" to generate the OpenAPI specification</li>
                <li>The preview will refresh automatically</li>
            </ol>
            <p>The OpenAPI spec is stored in your project's <code>.liveapi/openapi.json</code> file.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function() {
            console.log('[Preview] Loading OpenAPI spec...');
            const specUrl = '/api/openapi.json?t=' + new Date().getTime();
            console.log('[Preview] Fetching from:', specUrl);
            
            // Try to load the OpenAPI spec from project directory with cache busting
            fetch(specUrl)
                .then(response => {
                    console.log('[Preview] Response status:', response.status);
                    console.log('[Preview] Response headers:', response.headers);
                    
                    if (!response.ok) {
                        console.error('[Preview] Response not OK:', response.status, response.statusText);
                        throw new Error('Spec not found');
                    }
                    return response.json();
                })
                .then(spec => {
                    console.log('[Preview] Spec loaded successfully:', spec);
                    console.log('[Preview] Spec title:', spec.info?.title);
                    
                    // Hide the no-spec message
                    document.getElementById('no-spec').style.display = 'none';
                    document.getElementById('swagger-ui').style.display = 'block';
                    
                    // Initialize Swagger UI
                    window.ui = SwaggerUIBundle({
                        spec: spec,
                        dom_id: '#swagger-ui',
                        deepLinking: true,
                        presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                        ],
                        plugins: [
                            SwaggerUIBundle.plugins.DownloadUrl
                        ],
                        layout: "StandaloneLayout",
                        validatorUrl: null
                    });
                    console.log('[Preview] Swagger UI initialized');
                })
                .catch(error => {
                    console.error('[Preview] Error loading spec:', error);
                    console.error('[Preview] Full error:', error.message, error.stack);
                    
                    // Show the no-spec message
                    document.getElementById('swagger-ui').style.display = 'none';
                    document.getElementById('no-spec').style.display = 'flex';
                    console.log('No OpenAPI spec found. Generate one first.');
                });
        }
    </script>
</body>
</html>
